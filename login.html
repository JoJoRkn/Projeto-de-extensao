<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WorkSwipe ‚Äî Login</title>
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/login.css" />
  <link rel="icon" href="data:," />
</head>
<body>

    <!-- Idioma -->
    <div class="lang-switch">
        <span>üåê</span>
        <select id="localeSelect" class="small">
            <option value="pt">Portugu√™s</option>
            <option value="en">English</option>
        </select>
    </div>

    <div id="loginScreen" class="login-screen">
        <div class="login-box">

            <h1 id="titleApp">WorkSwipe</h1>
            <h2 id="titleConnect">Conecte-se</h2>

            <label for="loginType" id="labelAccountType">Tipo de conta:</label>
            <select id="loginType">
                <option value="candidate" id="optCandidate">Candidato</option>
                <option value="employer" id="optEmployer">Empresa</option>
            </select>

            <input type="email" id="loginEmail" placeholder="E-mail" />
            <input type="password" id="loginPassword" placeholder="Senha" />

            <button id="btnLogin" class="btn">Entrar</button>
            <button id="btnRegister" class="btn small">Criar Conta</button>
            <button id="btnForgot" class="btn small">Esqueci minha senha</button>

            <button id="btnGoogle" class="btn small btn-google">
                <span id="btnGoogleLabel">Entrar com Google</span>
            </button>

            <small id="loginMessage"></small>
        </div>
    </div>

<script type="module">

    import { apiLogin, apiRegister } from "./assets/js/api.js";
    import { resetPassword, loginWithGoogle } from "./assets/js/firebase-config.js";
    import { t, setLocale, getLocale, onLocaleChange } from "./assets/js/tradutor.js";

    window.__ES_MODULE__ = true;

    // elementos
    const loginForm = {
        type: document.getElementById('loginType'),
        email: document.getElementById('loginEmail'),
        password: document.getElementById('loginPassword'),
        loginBtn: document.getElementById('btnLogin'),
        registerBtn: document.getElementById('btnRegister'),
        forgotBtn: document.getElementById('btnForgot'),
        googleBtn: document.getElementById('btnGoogle'),
        message: document.getElementById('loginMessage'),
    };

    function showMessage(msg, error = false) {
        loginForm.message.textContent = msg;
        loginForm.message.style.color = error ? "#ff4444" : "#44ff44";
    }

    // LOGIN via Spring Boot API
    loginForm.loginBtn.addEventListener("click", async () => {

        const email = loginForm.email.value;
        const password = loginForm.password.value;

        if (!email || !password) 
            return showMessage("Preencha todos os campos!", true);

        loginForm.loginBtn.disabled = true;
        showMessage("Entrando...");

        const result = await apiLogin(email, password);

        loginForm.loginBtn.disabled = false;

        if (result.status !== "ok") {
            return showMessage("Erro: " + (result.message || "Falha no login"), true);
        }

        // salva local
        const currentUser = {
            uid: result.uid,
            email: result.email
        };
        localStorage.setItem("currentUser", JSON.stringify(currentUser));

        // sinaliza ao index.html
        window.parent.postMessage({ type: "login-success", user: currentUser }, "*");

        showMessage("Login realizado!");
    });

    // REGISTRO via Spring Boot API
    loginForm.registerBtn.addEventListener("click", async () => {

        const email = loginForm.email.value;
        const password = loginForm.password.value;
        const type = loginForm.type.value;

        if (!email || !password) 
            return showMessage("Preencha todos os campos!", true);

        if (password.length < 6)
            return showMessage("A senha deve ter pelo menos 6 caracteres.", true);

        loginForm.registerBtn.disabled = true;
        showMessage("Criando conta...");

        const result = await apiRegister(email, password, type);

        loginForm.registerBtn.disabled = false;

        if (result.status !== "created") {
            return showMessage("Erro: " + (result.message || "N√£o foi poss√≠vel registrar"), true);
        }

        showMessage("Conta criada com sucesso!");
    });

    // ESQUECI A SENHA (continua via Firebase)
    loginForm.forgotBtn.addEventListener("click", async () => {
        const email = loginForm.email.value;
        if (!email) return showMessage("Digite seu e-mail!", true);

        try {
            await resetPassword(email);
            showMessage("E-mail enviado.");
        } catch (err) {
            showMessage("Erro: " + err.message, true);
        }
    });

</script>

</body>
</html>
